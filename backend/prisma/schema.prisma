// Prisma schema for FlexiPrice
// This is your Prisma schema file for the database

generator client {
  provider                    = "prisma-client-py"
  interface                   = "asyncio"
  recursive_type_depth        = 5
  enable_experimental_decimal = true
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id          Int      @id @default(autoincrement())
  sku         String   @unique
  name        String
  description String?
  category    String?
  basePrice   Decimal  @map("base_price") @db.Decimal(12, 2)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // A/B Testing Fields
  experimentGroup    ExperimentGroup? @default(CONTROL) @map("experiment_group")
  experimentAssignedAt DateTime?      @map("experiment_assigned_at")
  
  // Relations
  inventoryBatches InventoryBatch[]
  priceHistory     PriceHistory[]
  orderItems       OrderItem[]
  experimentMetrics ExperimentMetric[]

  @@map("products")
}

model InventoryBatch {
  id         Int      @id @default(autoincrement())
  productId  Int      @map("product_id")
  batchCode  String?  @map("batch_code")
  quantity   Int
  expiryDate DateTime @map("expiry_date") @db.Date
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  product        Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  batchDiscounts BatchDiscount[]

  @@map("inventory_batches")
}

model BatchDiscount {
  id            Int       @id @default(autoincrement())
  batchId       Int       @map("batch_id")
  computedPrice Decimal   @map("computed_price") @db.Decimal(12, 2)
  discountPct   Decimal   @map("discount_pct") @db.Decimal(5, 2)
  validFrom     DateTime  @default(now()) @map("valid_from")
  validTo       DateTime? @map("valid_to")
  expiresAt     DateTime? @map("expires_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  mlRecommended Boolean   @default(false) @map("ml_recommended")

  // Relations
  batch InventoryBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId, validFrom, validTo])
  @@index([expiresAt])
  @@map("batch_discounts")
}

model PriceHistory {
  id            Int      @id @default(autoincrement())
  productId     Int      @map("product_id")
  price         Decimal  @db.Decimal(12, 2)
  discountPct   Decimal  @map("discount_pct") @db.Decimal(5, 2)
  reason        String? // "expiry", "ml_recommended", "manual", etc.
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("price_history")
}

model Order {
  id          Int         @id @default(autoincrement())
  orderNumber String      @unique @map("order_number")
  customerEmail String?   @map("customer_email")
  totalAmount Decimal     @map("total_amount") @db.Decimal(12, 2)
  status      OrderStatus @default(PENDING)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  items OrderItem[]

  @@map("orders")
}

model OrderItem {
  id            Int     @id @default(autoincrement())
  orderId       Int     @map("order_id")
  productId     Int     @map("product_id")
  quantity      Int
  unitPrice     Decimal @map("unit_price") @db.Decimal(12, 2)
  discountPct   Decimal @map("discount_pct") @db.Decimal(5, 2)
  totalPrice    Decimal @map("total_price") @db.Decimal(12, 2)

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}

enum ExperimentGroup {
  CONTROL      // Rule-based discounts
  ML_VARIANT   // ML-recommended discounts
}

// Track A/B experiment metrics per product
model ExperimentMetric {
  id                 Int      @id @default(autoincrement())
  productId          Int      @map("product_id")
  experimentGroup    ExperimentGroup @map("experiment_group")
  
  // Metrics
  impressions        Int      @default(0)  // Views
  conversions        Int      @default(0)  // Purchases
  revenue            Decimal  @default(0) @db.Decimal(12, 2)
  unitsSold          Int      @default(0) @map("units_sold")
  avgDiscountPct     Decimal? @map("avg_discount_pct") @db.Decimal(5, 2)
  
  // Time tracking
  periodStart        DateTime @map("period_start")
  periodEnd          DateTime @map("period_end")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, experimentGroup, periodStart])
  @@index([experimentGroup])
  @@index([periodStart, periodEnd])
  @@map("experiment_metrics")
}
